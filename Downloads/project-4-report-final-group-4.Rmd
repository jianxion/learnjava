---
title: "Project 4 Report"
author: "Weijiang Hou, Nathaniel Morgan, Christian Otto, & Jianxiong Shen"
date: "04/22/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 3)
library(tidyverse)
theme_set(theme_bw())
library(ggpubr)
library("pander")
library("ggfortify")
library("ggthemes")
```


## Introduction

In the early stages of processing, natural fibers (such as cotton and wool) require cleaning. A downside of cleaning is that the process results in a loss of wool. For wool sellers, losing wool weight is detrimental for their business because it causes their overall wool production to decrease, which causes them to miss out on possible profit. Therefore, it is important to know which wool cleaning process results in the least wool lost. To achieve this goal, a textile specialist investigated four cleaning processes. Wool from five different ranchers, suppliers, etc, were received for the study. After removing foreign debris, the wool from each batch was thoroughly mixed and an equal amount was assigned to each of the four cleaning processes. For our analysis, we will utilize the Randomized Complete Block Design to determine if there are differences in the wool weight loss for each process.

\vspace{12pt}

The data for this study is provided below. The sample includes 20 observations, with a single observation from each combination of Process and Batch. All the analysis was performed using the R programming language.

```{r data, echo=FALSE, comment=NA}
dat <- matrix(c(
  21, 26, 16, 28, 36, 38, 25, 35, 25, 27,
  22, 27, 18, 17, 18, 20, 22, 26, 21, 24
),
nrow = 4,
dimnames = list(
  c("1", "2", "3", "4"),
  c("1", "2", " 3", "4", "5")
)
)
dat_ex <- matrix(c(
  21, 26, 16, 28, 36, 38, 25, 35, 25, 27,
  22, 27, 18, 17, 18, 20, 22, 26, 21, 24
),
nrow = 4,
dimnames = list(
  c("Process 1", "        2", "        3", "        4"),
  c("Batch 1", "2", " 3", "4", "5")
)
)
pander(dat_ex)
```


```{r cleaning_dat, echo=FALSE}
clean_dat <- dat |>
  as_tibble() |>
  mutate(process = 1:4) |>
  pivot_longer(1:5,
    names_to = "batch",
    names_transform = list(batch = as.factor)
  )
clean_dat$process <- as.factor(clean_dat$process)
# head(clean_dat, 10)
```

\newpage

## Exploration

```{r scat_plot1, echo=FALSE}
clean_dat |>
  ggplot() +
  geom_point(aes(x = batch, y = value)) +
  facet_wrap(vars(process))
```

From the plot above, we can see that the batch variable seems to follow a specific pattern regardless of the process.

\vspace{12pt}

We now plot each of the batches to the corresponding process to look at the spread of data. The black dot represents the mean for a specific process.


```{r scat_plot2, echo=FALSE}
means <- clean_dat |>
  group_by(process) |>
  summarize(mean(value)) |>
  rename(value = "mean(value)")

ggplot() +
  geom_point(data = clean_dat, aes(x = process, y = value, color = batch), size = 4) +
  geom_point(data = means, aes(x = process, y = value), size = 2.5)
```


Since the process and batch are fixed, We are assuming we have a restricted model.

Often the actual differences in the treatment means are hidden because the large amount of variations within the treatment groups or cells. 
Often this variation can be explained by considering another variable (called a block or blocking effect) 
which partitions the variation in the treatment means into smaller homogeneous parts.

\newpage

We first fit a one-way ANOVA with the variable "process" to see if, ignoring the "batch" variable, there is a significant difference between processes.


```{r, echo=FALSE, comment=NA}
# Fitting a 1-way ANOVA with process
model_1way <- aov(value ~ process, data = clean_dat)
pander(summary(model_1way))
```

If we use process as the treatment only and ignore the batch variable, the process variable is not significant.

To get a better estimate of process, we should conduct a Randomized Complete Block Design and treat batch as a block variable.


The Randomized Complete Block Design is also known as the two-way ANOVA without interaction. A key assumption in the analysis is that the effect of each level of the treatment factor is the same for each level of the blocking factor. In RCBD, there is one observation for each combination of levels of the treatment and block factors.

The model for an RCBD (or two-way ANOVA without interactions) is:

$y_{ijk}   =  \mu + \tau_i   + \beta_j   + e_{ijk}$,
for  $i  =  1, 2, . . . , a,  j  =  1, 2, . . . , b$  and  $k  =  1, 2, . . . , n,  N   =  nab$.



Since it is a restricted model, the expected value for the mean square terms are,

$$E(MS_{block})=\sigma^2+a\frac{\sum^b_{j=1}\beta^2_j}{b-1}$$

$$E(MS_{treatment})=\sigma^2+b\frac{\sum^a_{i=1}\tau^2_i}{a-1}$$

$$E(MS_{error})=\sigma^2$$

There are two hypothesis tests in an RCBD, and they are always the same:

$H_0$: The means of all treatments are equal versus

$H_1$: At least one of the treatments has a different mean

and

$H_0$: The means of all blocks are equal versus

$H_1$: At least one of the blocks has a different mean


We will now conduct the Randomized Complete Block Design

\newpage

```{r, echo=FALSE, comment=NA}
model_2way <- aov(value ~ process + batch, data = clean_dat)
pander(summary(model_2way))
```

Now that we use the "batch" variable as a block variable, the process variable is significant. Therefore, we can reject the null hypothesis and state that there is sufficient evidence to conclude that at least one of the processes has a different mean.

\newpage

# Assumption checking

The first assumption to check is normality in the residuals:

```{r resid_norm_check, echo=FALSE}
ggqqplot(model_2way$residuals)
```

According to the qqplot, all of the values are close to the straight line and all of of them fall within the confidence interval. We can assume normality in the residuals.

To further support this, we conduct a shapiro-wilk test, where the hypotheses are as follows

$h_0:$ The data is normally distributed

$h_a:$ The data is not normally distributed

```{r shapiro, echo=FALSE, comment=NA}
pander(shapiro.test(model_2way$residuals))
```

The p-value for Shapiro-Wilk test is 0.962. We **do not** have sufficient evidence to suggest the data is **not** normally distributed.

\newpage

The next assumption we look at is the assumption of homoscedasticity:

```{r residuals check, echo=FALSE, fig.height=4}
plot(model_2way, 1)
```

We found that the residuals are randomly distributed around 0. We can assume equal variance.

## Multiple Comparisons

Now that we have concluded there is a difference in at least one of the means, we will use Tukey's Honesty Significant Difference method to determine where this difference takes place

```{r multiple-comparisons, echo=FALSE, comment=NA, message = FALSE, warning=FALSE}
pander(TukeyHSD(model_2way, "process")$process)
```

```{r, echo=FALSE}
x <- c(seq(1, 6, 1))
mean <- c(TukeyHSD(model_2way)$process[, 1])
lower <- c(TukeyHSD(model_2way)$process[, 2])
upper <- c(TukeyHSD(model_2way)$process[, 3])
Type <- c("2-1", "3-1", "4-1", "3-2", "4-2", "4-3")
len <- upper - lower
mydata <- data.frame(mean = mean, lower = lower, upper = upper, Type = Type, len = len)
ggplot(mydata, aes(x = x, y = mean, colour = Type)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2, size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
  geom_line() +
  geom_point() +
  theme_few()
```

We are 95% confident

• that the mean response losses in weight from process 2 is between -2.661664 and 7.461664 milligrams more than that of process 1, there is no statistical difference.

• that the mean response losses in weight from process 3 is between -9.061664 and 1.061664 milligrams more than that of process 1, there is no statistical difference.

• that the mean response losses in weight from process 4 is between -2.661664 and 7.461664 milligrams more than that of process 1, there is no statistical difference.

• that the mean response losses in weight from process 3 is between -11.461664 and -1.338336 milligrams more than that of process 2, there is a statistical difference.

• that the mean response losses in weight from process 4 is between -5.061664 and 5.061664 milligrams more than that of process 2, there is no statistical difference.

• that the mean response losses in weight from process 4 is between 1.338336 and 11.461664 milligrams more than that of process 3, there is a statistical difference.

## Conclusion

The Randomized Complete Block Design is the model we should use. The batch variable does explain some of the variance for the processes. It indicates there is a difference in the means for the processes. After conducting multiple comparisons, we are confident that process 3 is the best due to the lowest loss in weight.

