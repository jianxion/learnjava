---
title: "Intro to ggplot2 and Shiny"
author: "Michael Kleinsasser"
date: "10/13/2020"
output:
  ioslides_presentation:
    logo: Biostat-formal.png
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
```

## Background

 * Mike Kleinsasser, MS in Statistics
 
 * Hired as staff R programmer focused on R packages

 * Aid students and faculty in R package development/maintenance 
 
 * Typically one of two scenarios:
 
 * You develop a set of statistical methods for R
   - I help package, test, disseminate the code
   
 * You've developed a complete R package
   - I help ensure package meets standards and advise on package structure
   
## Background (continued)

 * Maintain a catalog of statistical software on our department website
 
 * Host a number of Shiny apps for members of the department (free for students and faculty)
 
 * Workshops on various useful R packages and on R package development (dates posted in the department events emails)
 
 * Please feel free to email me at mkleinsa@umich.edu if you would like help developing an R package or are interested in a workshop topic
 
## ggplot2

 * "ggplot2 is a system for declaratively creating graphics"
 
 * R implementation of the `grammar of graphics`
 
 1. Provide data,
 
 2. Tell ggplot2 how to map variables to aesthetics
 
 3. which graphical primitives to be used
 
 4. Thematic settings
 
 * Many of the unnecessary details are managed by program behind the scenes 
 
## The grammar of graphics

 * grammar of graphics is the philosophy of visualization underpinning the software
 
 * textbook: https://ggplot2-book.org/index.html
 
 * The grammar creates graphics by combining independent components
 
 * All plots composed of `data` and `mappings`
 
 * There are 5 `mapping` components:
 
## the 5 components

 * There are 5 `mapping` components:
 
 * `layer` - collection of geometric elements and statistical transformations
   - `geom`s are visual elements: points, lines, polygons, etc.
   - `stat`s summarize data, e.g., counts in a histogram
 
 * `scales` - map values in data space to values in aesthetic space
 
 * `coord`- dictates how data coordinates are mapped to a plane
 
 * `facet` - divide display into multiples with more clarity
 
 * `theme` - finer points, color, font size, background - purely for looks

## Build a scatterplot

```{r, eval = FALSE}
library(ggplot2)
ggplot(mpg) + 
   aes(displ, hwy, colour = factor(cyl)) +
   geom_point()
```

 * represents each observation by a point `geom`etry
 
 * the `aes`thetics of plot are horizontal position `x`, vertical position `y`, 
 and `color`. Inspect which variables are mapped to these `aes`thetics
 
 * the collection of data, geom, stat, and aesthetic here form a complete `layer`
 
## Example
 
 * Example: using the base aesthetic, form a layer from an alternate geometry
   - note that a `stat` transformation may be required
   
```{r, eval = FALSE}
ggplot(mpg) + 
   aes(displ, hwy, colour = factor(cyl))
```

 * some named plots and their `geom`s
   - scatterplot, bubblechart (`geom_point`)
   - bar chart (`geom_bar`)
   - box and whisker (`geom_boxplot`)
   - line chart (`geom_line`)
   
## Example to illustrate ggplot2

 - Let's produce this economist plot to illustrate the grammar
 
```{r, echo = FALSE}
include_graphics("economist.png", dpi = 400)
```
   
   
## Guess the layers

 * `layers` create the objects that we perceive of the plot, and is
 composed of the parts:
   - `data`, `aes`thetic, `stat`istical transformation, `geom`etric object
   
 * The economist plot is a ______ plot with ___, ____, ___ by ______:

```{r, echo = FALSE}
include_graphics("economist.png", dpi = 500)
```

## Layers
 * `layers` create the objects that we perceive of the plot, and is
 composed of the parts:
   - `data`, `aes`thetic, `stat`istical transformation, `geom`etric object
   
 * The economist plot is a scatter plot with CPI, HDI, color by Region:
   
```{r, warning=FALSE, message=FALSE}
EconomistData = read_csv("./EconomistData.csv")
ggplot(EconomistData) +
   aes(CPI, HDI, color = Region) + 
   geom_point()
```

 * Use the final plot to speculate on the "other" layers. Any ideas?
 
## Guess the aesthetics

 * visual properties of objects on the graph

 * requirements of `aes` vary, but some common ones:
   - x, y, color, fill, linetype, shape, size, alpha
   
```{r, echo = FALSE}
include_graphics("economist.png", dpi = 500)
```
   
## Aesthetics

 * visual properties of objects on the graph

 * requirements of `aes` vary, but some common ones:
   - x, y, color, fill, linetype, shape, size, alpha
 
 * any aesthetic that does not differ over the data set can simply be set outside of `aes`, and are simply considered settings

```{r, eval = FALSE}
EconomistData = read_csv("./EconomistData.csv")
eco_base = 
   ggplot(EconomistData) +
   aes(CPI, HDI, color = Region) + 
   geom_point(shape = 1, size = 3, stroke = 2) + 
   geom_smooth(method = "lm",
               formula = y ~ x + log(x), se = FALSE,
               color = "red")
```

 * So far, what are the aesthetics and settings?
 
## Guess the scales

 * defines which aesthetic values are mapped to data values
 
 * `scale_` functions control every scale
   - `scale_aes_suffix`, e.g., `scale_x_discrete()`
   
```{r, echo = FALSE}
include_graphics("economist.png", dpi = 500)
```
 
## Scales

 * defines which aesthetic values are mapped to data values
 
 * `scale_` functions control every scale
   - `scale_aes_suffix`, e.g., `scale_x_discrete()`
   
```{r, eval = FALSE}
eco_base = eco_base + 
   scale_x_continuous(name = "Corruption Perceptions Index, 2011 
                      (10=least corrupt)",
                       limits = c(.9, 10.5),
                       breaks = 1:10) +
    scale_y_continuous(name = "Human Development Index, 2011 (1=Best)",
                       limits = c(0.2, 1.0),
                       breaks = seq(0.2, 1.0, by = 0.1)) +
    scale_color_manual(name = "",
                       values = c("#24576D","#099DD7","#28AADC",
                        "#248E84","#F2583F","#96503F"))
```

## Guess the themes

 - elements not related to data, e.g. background color, font size, gridlines
 
```{r, echo = FALSE}
include_graphics("economist.png", dpi = 500)
```

## Themes

 - elements not related to data, e.g. background color, font size, gridlines
 
 * huge number of settings, better to search when you need them
 
 * useful min. theme is `theme_minimal()`
 
```{r, eval = FALSE}
eco_base = 
   eco_base + 
   theme_minimal()
```

## Themes continued

```{r, eval = FALSE}
eco_base = eco_base + 
theme(text = element_text(color = "gray20"),
          legend.position = c("top"),  
          legend.direction = "horizontal",
          legend.justification = 0.1, 
          legend.text = element_text(size = 11, color = "gray10"),
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2), 
          axis.ticks.y = element_blank(), 
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank())
```

## Final touches

 * label some countries of interest, with repel for easier reading
 
 * add the title

```{r, eval = FALSE}
country_labels =  c("Russia", "Venezuela", "Iraq", "Myanmar", 
                    "Sudan", "Afghanistan", "Congo", "Greece", 
                    "Argentina", "Brazil", "United States", 
                    "Germany", "Britain", "Barbados", "Norway", 
                      "Japan", "New Zealand", "Singapore")
eco_base = eco_base + 
   geom_text_repel(aes(label = Country), color = "black", 
                   data = filter(EconomistData, 
                                 Country %in% country_labels)) + 
   ggtitle("Corruption and Human development")
```

## Shiny

 * Shiny - interactive web app framework for R
 
 * Implements a "reactive" binding between inputs and outputs for responsive user experience
 
 * Extensive set of pre-built widgets for assembling apps with very little effort
 
 * Combined, these provide a fairly intuitive, fast platform for making apps

## Reactivity

 * Reactive programming model - state of application responds to change in real time
 
 * Reactivity comes in three varieties: reactive sources, reactive conductors,
 reactive endpoints
 
 * Reactive source: user input through a browser interface, e.g., dropdown menu selection
 
 * Reactive endpoint: result that appears in user's browser window, e.g., printed text
 
## Reactivity (continued)
 
 * The `input` object carries (or stores) the reactive source objects as a list
 
 * The `output` stores the reactive endpoint objects as a list
 
 * ALL inputs from the user live in `input`
 
 * ALL output you program into the server lives in `output`
 
## Building an example app

General user experience:

 1. Decide what the user needs to provide to the app
 
 2. Decide what the server needs to compute from what input values, 
 and how the result should look on the screen

## First Shiny App

 * Implement the following reactive logic into a Shiny app:
 
 * Require user to select between two choices (Hi, Siri or Bye, Siri)
 
 * Print Siri's response to the screen (either Hi, Mike or Bye, Mike)
 
## First Shiny App (Continued)

 * Implement the following reactive logic into a Shiny app:
 
 * Require user to select between two choices (Hi, Siri or Bye, Siri)
 
 * Shiny UI dropdown menu: selectInput()
 
 * Print Siri's response to the screen (either Hi, Mike or Bye, Mike)
 
 * Shiny UI text output: textOutput()
 
 * Each UI element needs a matching server element
 
## First Shiny App (Continued 2)
 
 * Require user to select between two choices (Hi, Siri or Bye, Siri)
 
 * Shiny UI dropdown menu: `selectInput()`
 
 * Print Siri's response to the screen (either Hi, Mike or Bye, Mike)
 
 * Shiny UI text output: `textOutput()`
 
 * Shiny reactive server object: `renderText({})`
 
## App skeleton

The UI - wrappers for HTML tags

```{r, eval = FALSE}
ui = fluidPage(
   # contents of the user interface
)
```

The server - function of reactive sources and endpoints (object ID's link between server and UI)

```{r, eval = FALSE}
server = function(input, output) {
   # contents of the server
}
```

Launcher

```{r, eval = FALSE}
shinyApp(ui, server)
```

## The UI code

```{r, eval = FALSE}
ui = fluidPage(
  selectInput(inputId = 'choice',
              label = 'Response: ',
              choice = c('Hi, Siri','Bye, Siri',''),
              selected = c('')
  ),
  textOutput('result')
)
```

 * Exercise: print `ui` to the console and inspect the print() result
 
## 3 Versions of server logic

 * In Shiny, you have options to achieve different aspects of reactivity:
 
 * ALL of these monitor the status of an input
 
 * `observe()`: continually monitors any changes in all reactive values within its environment and runs the code in it's environment when these values are changed. Not lazily evaluated.
 
 * `reactive()`: return the value to be used elsewhere in server code. "Reactive expressions use lazy evaluation; that is, when their dependencies change, they don't re-execute right away but rather wait until they are called by someone else."
 
 * `observeEvent()`:  similar to observe, but is triggered by a single event rather than all events.

## Version 1: observe()

 * Which variables exist in a reactive context?

```{r, eval = FALSE}
server = function(input,output,session)({
  text = reactiveValues()
  observe({
    if(input$choice == 'Hi, Siri') { text$result = 'Hi, Mike' }
    else if(input$choice == 'Bye, Siri') { text$result = 'Goodbye, Mike' }
    })
  output$result = renderText({ text$result })
})
```

## Version 2: reactive()

```{r, eval = FALSE}
server = function(input,output,session)({
  getStatus = reactive({
     if(input$choice == "Hi, Siri") { "Hello, Mike." }
     else if(input$choice == "Bye, Siri") { "See you later, Mike." }
  })
  output$result = renderText({ getStatus() })
})
```

## Version 3: observeEvent()

```{r, eval = FALSE}
server = function(input,output,session) {
   text = reactiveValues()
   observeEvent(input$choice, {
      if(input$choice == "Hi, Siri") { text$result = "Hello, Mike." }
      else if(input$choice == "Bye, Siri") { 
         text$result = "See you later, Mike."}
   })
   output$result = renderText({
      text$result
   })
}
```

## Shiny example from our department

 * [covid app](https://umich-biostatistics.shinyapps.io/covid19/)
